% ref-buttons.sty - Reference and citation buttons for beamer presentations
% Provides \furtherreading and \sourceref macros for creating clickable reference buttons
%
% CRITICAL NOTE: The \furtherreading macro must maintain the exact structure of \citelink
% to ensure clickable buttons. See the detailed comments in the macro definition.
% Previous attempts to add conditional logic or reorganize the macro structure resulted
% in buttons that appeared correct but were not clickable.

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ref-buttons}[2025/01/03 Reference buttons for beamer presentations]

% Required packages
\RequirePackage{textcase}  % For \NoCaseChange
\RequirePackage{hyperref}  % For hyperlinking
\RequirePackage{xstring}   % For string manipulation
\RequirePackage{ifthen}    % For conditional logic
\RequirePackage{xcolor}    % For color definitions

% Check if bibliography packages are needed and available
\newif\ifusebibpackages
\IfFileExists{references.bib}{
  \usebibpackagestrue
  \RequirePackage{usebib}
  \RequirePackage[backend=biber, style=authoryear]{biblatex}
  \addbibresource{./references.bib}
  \bibinput{references}
}{
  \usebibpackagesfalse
  \PackageWarning{ref-buttons}{No references.bib found. Bibliography features will be limited.}
}

% Define custom colors for the buttons
\definecolor{furtherreadingcolor}{RGB}{173, 216, 230}    % Light blue background for further reading
\definecolor{sourcerefcolor}{RGB}{255, 218, 185}         % Light orange/peach background for source references

% Helper macro to create a colored beamer button
% #1: color, #2: url, #3: text
\newcommand{\refbutton}[3]{%
  \resizebox{!}{9pt}{%
    \protect\hyperlink{#2}{%
      {%
        \setbeamercolor{button}{bg=#1,fg=black}%
        \beamerbutton{#3}%
      }%
    }%
  }%
}

% Helper macro to create a colored beamer goto button with URL
% #1: color, #2: url, #3: text
\newcommand{\refgotobutton}[3]{%
  \resizebox{!}{9pt}{%
    {%
      \setbeamercolor{button}{bg=#1,fg=black}%
      \protect\beamergotobutton{%
        \href{#2}{#3}%
      }%
    }%
  }%
}

% Further reading macro - creates a blue button with citation
% Usage: \furtherreading{citekey}
\newcommand{\furtherreading}[1]{%
  % IMPORTANT: This macro must maintain the EXACT structure of \citelink to ensure clickability
  % Previous attempts with conditional logic, URL detection, or different nesting orders
  % resulted in non-clickable buttons despite appearing correct visually.
  %
  % The working structure is:
  % \beamergotobutton{\href{url}{text}} - NOT \href{url}{\beamergotobutton{text}}
  %
  % Key components that must be preserved:
  % 1. \NoCaseChange wrapper - handles uppercase citation keys (e.g., CITEKEY)
  % 2. \resizebox{!}{9pt} - sets button size to 9pt height
  % 3. \protect\beamergotobutton - creates the beamer button with protection
  % 4. \href{\usebibentry{...}{url}}{...} - creates the hyperlink using bibliography URL
  % 5. \begin{NoHyper}...\end{NoHyper} - prevents nested hyperlinks in citation text
  % 6. \cite{#1} - displays the citation (e.g., "Author 2025")
  %
  % The color setting is wrapped in a group {...} to localize the change
  {%
    \setbeamercolor{button}{bg=furtherreadingcolor,fg=black}%
    % This line MUST match \citelink exactly - DO NOT add conditionals or reorganize
    \NoCaseChange{\resizebox{!}{9pt}{\protect\beamergotobutton{\href{\usebibentry{\NoCaseChange{#1}}{url}}{\begin{NoHyper}\cite{#1}\end{NoHyper}}}}}%
  }%
}

% Source reference macro - creates an orange button
% Usage: \sourceref{url} or \sourceref{citekey}
\newcommand{\sourceref}[1]{%
  % Check if the argument looks like a URL (contains :// or starts with www.)
  \IfSubStr{#1}{://}{%
    % It's a URL
    \refgotobutton{sourcerefcolor}{#1}{Click for source}%
  }{%
    \IfSubStr{#1}{www.}{%
      % It's a URL starting with www.
      \refgotobutton{sourcerefcolor}{http://#1}{Click for source}%
    }{%
      % Assume it's a citation key
      \ifusebibpackages
        % Try to get URL from bibliography entry
        \@ifundefined{usebibentry@url@#1}{%
          % No URL found, maybe it's a URL without protocol
          \refgotobutton{sourcerefcolor}{http://#1}{Click for source}%
        }{%
          % URL exists in bibliography
          \refgotobutton{sourcerefcolor}{\usebibentry{\NoCaseChange{#1}}{url}}{Click for source}%
        }%
      \else
        % No bibliography packages, treat as URL
        \refgotobutton{sourcerefcolor}{http://#1}{Click for source}%
      \fi
    }%
  }%
}

\endinput
