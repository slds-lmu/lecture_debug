% ref-buttons.sty - Reference and citation buttons for beamer presentations
% Provides \furtherreading and \sourceref macros for creating clickable reference buttons
%
% CRITICAL NOTE: The \furtherreading macro must maintain the exact structure of \citelink
% to ensure clickable buttons. See the detailed comments in the macro definition.
% Previous attempts to add conditional logic or reorganize the macro structure resulted
% in buttons that appeared correct but were not clickable.

\NeedsTeXFormat{LaTeX2e}

% Required packages
\RequirePackage{textcase}  % For \NoCaseChange
\RequirePackage{hyperref}  % For hyperlinking
\RequirePackage{xstring}   % For string manipulation
\RequirePackage{ifthen}    % For conditional logic
\RequirePackage{xcolor}    % For color definitions

% Check if bibliography packages are needed and available
\newif\ifusebibpackages
\IfFileExists{references.bib}{
  \usebibpackagestrue
  \RequirePackage{usebib}
  \RequirePackage[backend=biber, style=authoryear]{biblatex}
  \addbibresource{./references.bib}
  \bibinput{references}
}{
  \usebibpackagesfalse
  \PackageWarning{ref-buttons}{No references.bib found. Bibliography features will be limited.}
}

% Define custom colors for the buttons
\definecolor{furtherreadingcolor}{RGB}{173, 216, 230}    % Light blue background for further reading
\definecolor{sourcerefcolor}{RGB}{255, 218, 185}         % Light orange/peach background for source references

% NOTE: Helper macros removed - using direct implementations to ensure clickability

% Further reading macro - creates a blue button with citation
% Usage: \furtherreading{citekey}
\newcommand{\furtherreading}[1]{%
  % IMPORTANT: This macro must maintain the EXACT structure of \citelink to ensure clickability
  % Previous attempts with conditional logic, URL detection, or different nesting orders
  % resulted in non-clickable buttons despite appearing correct visually.
  %
  % The working structure is:
  % \beamergotobutton{\href{url}{text}} - NOT \href{url}{\beamergotobutton{text}}
  %
  % Key components that must be preserved:
  % 1. \NoCaseChange wrapper - handles uppercase citation keys (e.g., CITEKEY)
  % 2. \resizebox{!}{9pt} - sets button size to 9pt height
  % 3. \protect\beamergotobutton - creates the beamer button with protection
  % 4. \href{\usebibentry{...}{url}}{...} - creates the hyperlink using bibliography URL
  % 5. \begin{NoHyper}...\end{NoHyper} - prevents nested hyperlinks in citation text
  % 6. \cite{#1} - displays the citation (e.g., "Author 2025")
  %
  \ifusebibpackages
    % Create the button - let \cite and \usebibentry handle errors for missing citations
    % The color setting is wrapped in a group {...} to localize the change
    {%
      \setbeamercolor{button}{bg=furtherreadingcolor,fg=black}%
      % This line MUST match \citelink exactly - DO NOT add conditionals or reorganize
      \NoCaseChange{\resizebox{!}{9pt}{\protect\beamergotobutton{\href{\usebibentry{\NoCaseChange{#1}}{url}}{\begin{NoHyper}\cite{#1}\end{NoHyper}}}}}%
    }%
  \else
    % No bibliography packages loaded - cannot use citation keys
    \PackageError{ref-buttons}{Cannot use \string\furtherreading without bibliography}%
      {You tried to use \string\furtherreading with '#1', but no bibliography^^J%
       packages are loaded. Ensure references.bib exists.}%
  \fi
}

% Source reference macro - creates an orange button
% Usage: \sourceref{url} or \sourceref{citekey}
\newcommand{\sourceref}[1]{%
  % Check if the argument looks like a URL (contains :// or starts with www.)
  \IfSubStr{#1}{://}{%
    % It's a URL with protocol
    {%
      \setbeamercolor{button}{bg=sourcerefcolor,fg=black}%
      \resizebox{!}{9pt}{%
        \protect\beamergotobutton{%
          \href{#1}{Click for source}%
        }%
      }%
    }%
  }{%
    \IfSubStr{#1}{www.}{%
      % It's a URL starting with www.
      {%
        \setbeamercolor{button}{bg=sourcerefcolor,fg=black}%
        \resizebox{!}{9pt}{%
          \protect\beamergotobutton{%
            \href{http://#1}{Click for source}%
          }%
        }%
      }%
    }{%
      % Assume it's a citation key - use the same structure as \furtherreading
      % but with orange color and "Click for source" text
      \ifusebibpackages
        % Create button with URL from bibliography - let \usebibentry handle errors
        {%
          \setbeamercolor{button}{bg=sourcerefcolor,fg=black}%
          \NoCaseChange{\resizebox{!}{9pt}{\protect\beamergotobutton{\href{\usebibentry{\NoCaseChange{#1}}{url}}{Click for source}}}}%
        }%
      \else
        % No bibliography packages loaded - cannot use citation keys
        \PackageError{ref-buttons}{Cannot use citation keys without bibliography}%
          {You tried to use '#1' as a citation key, but no bibliography^^J%
           packages are loaded. Either provide a URL or ensure references.bib exists.}%
      \fi
    }%
  }%
}

\endinput
